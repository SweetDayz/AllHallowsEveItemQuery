<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>靜態查詢資料庫</title>
    
    <script src="database.js"></script>
    <script src="descriptions.js"></script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 2rem;
            background-color: #f4f7f6;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }
        .container {
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            background: #fff;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        h1 {
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-top: 0;
        }
        /* [新增] 搜尋框樣式 */
        #searchBox {
            width: 100%;
            padding: 10px 12px;
            font-size: 16px;
            border-radius: 6px;
            border: 1px solid #ddd;
            box-sizing: border-box; /* 確保 padding 不會撐開寬度 */
            margin-bottom: 1.5rem;
        }
        .form-group {
            margin-bottom: 1.5rem;
        }
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }
        select {
            width: 100%;
            padding: 10px 12px;
            font-size: 16px;
            border-radius: 6px;
            border: 1px solid #ddd;
            -webkit-appearance: none;
            appearance: none;
            background-color: #fff;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23007AFF%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 0.65em auto;
        }
        .query-section {
            display: none;
            border-top: 1px dashed #ccc;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
        }
        
        /* 詳情顯示區域 */
        #detailsContainer {
            margin-top: 2rem;
            padding: 1.5rem;
            background-color: #f9f9f9;
            border-radius: 6px;
            border: 1px solid #eee;
            display: none;
            line-height: 1.6;
            word-wrap: break-word;
        }
        #detailsContainer h3 {
            margin-top: 0;
            margin-bottom: 0.25rem;
            color: #0056b3;
        }
        #detailsContainer .sub-name {
            font-family: monospace;
            font-size: 0.9em;
            color: #666;
            margin-top: 0;
            margin-bottom: 1rem;
        }
        #detailsContainer .category-rarity {
            font-size: 0.9em;
            font-style: italic;
            color: #555;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #eee;
            margin-bottom: 1rem;
        }
        #detailsContainer p {
            margin: 0.5rem 0;
        }
        #detailsContainer p strong {
            color: #333;
            min-width: 65px;
            display: inline-block;
        }
        .description-text {
            white-space: pre-wrap;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #eee;
            font-size: 0.95em;
        }
        .reward-description {
            background-color: #e6f0ff;
            border: 1px solid #b3d1ff;
            border-radius: 4px;
            padding: 0.8rem 1.2rem;
            margin-top: 1.5rem;
        }
        .reward-description p { margin: 0.2rem 0; }
        .reward-description strong {
            color: #0056b3;
            display: block;
            margin-bottom: 0.5rem;
        }
        .reward-description .category-rarity {
            border-top: 1px dashed #b3d1ff;
            border-bottom: none;
            margin-top: 0.8rem;
            padding-top: 0.8rem;
        }
        /* [新增] 搜尋高亮 */
        .highlight {
            background-color: yellow;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>查詢資料庫</h1>
        
        <div class="form-group">
            <input type="text" id="searchBox" placeholder="搜尋物品名稱 (中/英文)...">
        </div>

        <div class="form-group">
            <label for="queryTypeSelect">或依類別瀏覽：</label>
            <select id="queryTypeSelect">
                <option value="">— 請選擇類別 —</option>
                <option value="shops">商店物品</option>
                <option value="tasks">任務列表</option>
                <option value="loot">Loot 掉落</option>
            </select>
        </div>

        <div id="shopsSection" class="query-section">
            <div class="form-group">
                <label for="shopSelect">選擇商店：</label>
                <select id="shopSelect">
                    <option value="">— 請選擇商店 —</option>
                </select>
            </div>
            <div class="form-group">
                <label for="shopItemSelect">選擇物品：</label>
                <select id="shopItemSelect" disabled>
                    <option value="">— 請先選擇商店 —</option>
                </select>
            </div>
        </div>

        <div id="tasksSection" class="query-section">
            <div class="form-group">
                <label for="taskSelect">選擇任務類別：</label>
                <select id="taskSelect">
                    <option value="">— 請選擇任務類別 —</option>
                </select>
            </div>
            <div class="form-group">
                <label for="taskItemSelect">選擇任務：</label>
                <select id="taskItemSelect" disabled>
                    <option value="">— 請先選擇任務類別 —</option>
                </select>
            </div>
        </div>

        <div id="lootSection" class="query-section">
            <div class="form-group">
                <label for="lootItemSelect">選擇 Loot 物品：</label>
                <select id="lootItemSelect">
                    <option value="">— 請選擇物品 —</option>
                </select>
            </div>
        </div>

        <div id="detailsContainer">
            </div>
    </div>

    <script>
        // 全域查找表
        const itemMasterList = new Map();
        
        // [新增] 防止無限迴圈的旗標
        let isUpdatingProgrammatically = false;

        // 獲取所有 HTML 元素
        const searchBox = document.getElementById('searchBox');
        const queryTypeSelect = document.getElementById('queryTypeSelect');
        const shopsSection = document.getElementById('shopsSection');
        const tasksSection = document.getElementById('tasksSection');
        const lootSection = document.getElementById('lootSection');
        
        const shopSelect = document.getElementById('shopSelect');
        const shopItemSelect = document.getElementById('shopItemSelect');
        const taskSelect = document.getElementById('taskSelect');
        const taskItemSelect = document.getElementById('taskItemSelect');
        const lootItemSelect = document.getElementById('lootItemSelect');
        const detailsContainer = document.getElementById('detailsContainer');

        // [輔助] 建立敘述區塊的 HTML
        function createDescriptionHtml(item, highlightTerm = "") {
            if (!item) return '';
            let html = '';
            
            const nameZh = highlight(item.name_zh || '', highlightTerm);
            const nameEn = highlight(item.name_en || '', highlightTerm);
            const descZh = highlight(item.desc_zh || '', highlightTerm);
            const descEn = highlight(item.desc_en || '', highlightTerm);

            html += `<h3>${nameZh}</h3>`;
            html += `<p class="sub-name">${nameEn}</p>`;
            
            if (item.category_zh || item.category_en) {
                html += `<div class="category-rarity">
                           <p>${item.category_zh || ''}</p>
                           <p>${item.category_en || ''}</p>
                         </div>`;
            }
            if (item.desc_zh) {
                html += `<div class="description-text">${descZh}</div>`;
            }
            if (item.desc_en) {
                html += `<div class="description-text">${descEn}</div>`;
            }
            return html;
        }
        
        // [輔助] 建立獎勵區塊的 HTML
        function createRewardHtml(rewardId, highlightTerm = "") {
            if (!rewardId) return '';
            const rewardItem = itemMasterList.get(rewardId);
            // [新增] 查無資料的機制
            if (!rewardItem) {
                 return `<div class="reward-description">
                            <strong>獎品資料遺失 (ID: ${rewardId})</strong>
                         </div>`;
            }

            return `<div class="reward-description">
                        <strong>獎品「${highlight(rewardItem.name_zh, highlightTerm)}」詳情：</strong>
                        ${createDescriptionHtml(rewardItem, highlightTerm)}
                      </div>`;
        }

        // [輔助] 搜尋高亮文字
        function highlight(text, term) {
            if (!term) return text;
            try {
                const regex = new RegExp(`(${escapeRegExp(term)})`, 'gi');
                return text.replace(regex, '<span class="highlight">$1</span>');
            } catch (e) {
                console.warn("Highlight regex error:", e);
                return text;
            }
        }

        // [輔助] 脫敏正則表達式特殊字元
        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        // [輔助] 重置「子選單」(Sub-menus)
        function resetSubMenus() {
            shopsSection.style.display = 'none';
            tasksSection.style.display = 'none';
            lootSection.style.display = 'none';
            detailsContainer.style.display = 'none';
            
            shopSelect.value = '';
            shopItemSelect.innerHTML = '<option value="">— 請先選擇商店 —</option>';
            shopItemSelect.disabled = true;
            taskSelect.value = '';
            taskItemSelect.innerHTML = '<option value="">— 請先選擇任務類別 —</option>';
            taskItemSelect.disabled = true;
            lootItemSelect.value = '';
        }

        /**
         * [核心] 應用程式主體
         */
        function startApp(database, descriptions) {
            
            // --- [ 1. 初始化 ] ---
            function initializeApp() {
                // 1.1 建立物品總表速查 Map
                for (const item of descriptions) {
                    itemMasterList.set(item.id, item);
                }

                // 1.2 載入商店選單
                for (const categoryId in database.shops.categories) {
                    shopSelect.appendChild(new Option(database.shops.categories[categoryId], categoryId));
                }

                // 1.3 載入任務選單
                for (const categoryId in database.tasks.categories) {
                    taskSelect.appendChild(new Option(database.tasks.categories[categoryId], categoryId));
                }

                // 1.4 動態計算並載入 "Loot" 物品
                const classifiedItemIds = new Set();
                for (const shopId in database.shops.items) {
                    for (const itemLink of database.shops.items[shopId]) {
                        classifiedItemIds.add(itemLink.item_id);
                    }
                }
                for (const taskId in database.tasks.items) {
                    for (const task of database.tasks.items[taskId]) {
                        if (task.reward_id) classifiedItemIds.add(task.reward_id);
                    }
                }
                
                const lootItems = [];
                for (const item of descriptions) {
                    if (!classifiedItemIds.has(item.id)) {
                        lootItems.push(item);
                    }
                }

                lootItems.sort((a, b) => a.name_zh.localeCompare(b.name_zh, 'zh-Hant'));
                lootItems.forEach(item => {
                    lootItemSelect.appendChild(new Option(item.name_zh, item.id));
                });
                
                // [新增] 如果 Loot 沒東西，顯示提示
                if (lootItems.length === 0) {
                     lootItemSelect.innerHTML = '<option value="">— 無 Loot 物品 —</option>';
                     lootItemSelect.disabled = true;
                }
            }

            // --- [ 2. 事件監聽 ] ---

            // [搜尋框] 監聽
            searchBox.addEventListener('input', (e) => {
                if (isUpdatingProgrammatically) return;

                const query = e.target.value.trim();

                if (query === "") {
                    detailsContainer.style.display = 'none';
                    return;
                }
                
                isUpdatingProgrammatically = true;
                queryTypeSelect.value = ''; // 只重置主選單的值
                isUpdatingProgrammatically = false;
                
                resetSubMenus();
                
                const lowerCaseQuery = query.toLowerCase();

                const results = [];
                // [已修改] 使用 allDescriptions (來自 .js 檔案)
                for (const item of allDescriptions) { 
                    if (item.name_zh.toLowerCase().includes(lowerCaseQuery) || 
                        item.name_en.toLowerCase().includes(lowerCaseQuery)) 
                    {
                        results.push(item);
                    }
                }

                if (results.length > 0) {
                    const firstResult = results[0];
                    let html = createDescriptionHtml(firstResult, query);
                    
                    // 嘗試找到它的商店資訊 (如果有)
                    let foundInShop = false;
                    for (const shopId in database.shops.items) {
                        const itemLink = database.shops.items[shopId].find(i => i.item_id === firstResult.id);
                        if (itemLink) {
                            const shopName = database.shops.categories[shopId] || shopId;
                            html += `<hr style="border:0; border-top:1px dashed #ccc; margin: 1rem 0;">`;
                            html += `<p><strong><em>可於 [${shopName}] 購買</em></strong></p>`;
                            html += `<p><strong>庫存：</strong> <span>${itemLink.stock || 'N/A'}</span></p>`;
                            html += `<p><strong>花費：</strong> <span>${itemLink.cost || 'N/A'}</span></p>`;
                            if (itemLink.buyback_price) {
                                html += `<p><strong>收購價：</strong> <span>${itemLink.buyback_price}</span></p>`;
                            }
                            foundInShop = true;
                            break; 
                        }
                    }
                    
                    detailsContainer.innerHTML = html;
                    detailsContainer.style.display = 'block';

                } else {
                    // [新增] 查無資料機制
                    detailsContainer.innerHTML = '<p>找不到符合條件的物品。</p>';
                    detailsContainer.style.display = 'block';
                }
            });

            // [主選單] 監聽
            queryTypeSelect.addEventListener('change', () => {
                if (isUpdatingProgrammatically) return;
                const selectedType = queryTypeSelect.value;
                
                isUpdatingProgrammatically = true;
                searchBox.value = ''; // 清空搜尋框
                isUpdatingProgrammatically = false;

                resetSubMenus();

                if (selectedType === 'shops') shopsSection.style.display = 'block';
                else if (selectedType === 'tasks') tasksSection.style.display = 'block';
                else if (selectedType === 'loot') lootSection.style.display = 'block';
            });

            // [商店] 選單監聽
            shopSelect.addEventListener('change', () => {
                const selectedShopId = shopSelect.value;
                shopItemSelect.innerHTML = '<option value="">— 請選擇物品 —</option>';
                detailsContainer.style.display = 'none';
                shopItemSelect.disabled = true;

                if (selectedShopId) {
                    const itemLinks = database.shops.items[selectedShopId] || [];
                    if (itemLinks.length > 0) {
                        const fullItems = itemLinks.map(link => ({
                            linkData: link,
                            itemData: itemMasterList.get(link.item_id)
                        })).filter(i => i.itemData); // 過濾掉總表中不存在的物品

                        fullItems.sort((a, b) => a.itemData.name_zh.localeCompare(b.itemData.name_zh, 'zh-Hant'));

                        fullItems.forEach(wrappedItem => {
                            shopItemSelect.appendChild(new Option(wrappedItem.itemData.name_zh, wrappedItem.linkData.item_id));
                        });
                        shopItemSelect.disabled = false;
                    } else {
                        // [新增] 查無資料機制
                        shopItemSelect.innerHTML = '<option value="">— 此商店無存貨 —</option>';
                    }
                }
            });

            // [商店] 物品監聽
            shopItemSelect.addEventListener('change', () => {
                const selectedItemId = shopItemSelect.value;
                if (!selectedItemId) {
                    detailsContainer.style.display = 'none'; return;
                }
                const item = itemMasterList.get(selectedItemId);
                if (!item) return;
                const itemLink = (database.shops.items[shopSelect.value] || []).find(i => i.item_id === selectedItemId);
                if (!itemLink) return; 

                let html = `<h3>${item.name_zh}</h3>`;
                html += `<p class="sub-name">${item.name_en || ''}</p>`;
                html += `<p><strong>庫存：</strong> <span>${itemLink.stock || 'N/A'}</span></p>`;
                html += `<p><strong>花費：</strong> <span>${itemLink.cost || 'N/A'}</span></p>`;
                if (itemLink.buyback_price) {
                    html += `<p><strong>收購價：</strong> <span>${itemLink.buyback_price}</span></p>`;
                }
                html += createDescriptionHtml(item);
                detailsContainer.innerHTML = html;
                detailsContainer.style.display = 'block';
            });

            // [任務] 選單監聽
            taskSelect.addEventListener('change', () => {
                const selectedTaskId = taskSelect.value;
                taskItemSelect.innerHTML = '<option value="">— 請選擇任務 —</option>';
                detailsContainer.style.display = 'none';
                taskItemSelect.disabled = true;

                if (selectedTaskId) {
                    const tasks = database.tasks.items[selectedTaskId] || [];
                    if (tasks.length > 0) {
                        tasks.sort((a, b) => a.name_zh.localeCompare(b.name_zh, 'zh-Hant'));
                        tasks.forEach(task => {
                            taskItemSelect.appendChild(new Option(task.name_zh, task.id));
                        });
                        taskItemSelect.disabled = false;
                    } else {
                        // [新增] 查無資料機制
                        taskItemSelect.innerHTML = '<option value="">— 此類別無任務 —</option>';
                    }
                }
            });

            // [任務] 項目監聽
            taskItemSelect.addEventListener('change', () => {
                const selectedTaskId = taskItemSelect.value;
                if (!selectedTaskId) {
                    detailsContainer.style.display = 'none'; return;
                }
                const task = (database.tasks.items[taskSelect.value] || []).find(t => t.id === selectedTaskId);
                if (!task) return;

                let html = `<h3>${task.name_zh}</h3>`;
                html += `<p class="sub-name">${task.name_en || ''}</p>`;
                if (task.reward_str) html += `<p><strong>賞金：</strong> <span>${task.reward_str}</span></p>`;
                if (task.cost_str) html += `<p><strong>花費：</strong> <span>${task.cost_str}</span></p>`;
                if (task.reward_id) {
                    const rewardItem = itemMasterList.get(task.reward_id);
                    if (rewardItem) {
                         html += `<p><strong>獎品：</strong> <span>${rewardItem.name_zh}</span></p>`;
                    }
                }
                if (task.desc_zh) html += `<div class="description-text">${task.desc_zh}</div>`;
                if (task.desc_en) html += `<div class="description-text">${task.desc_en}</div>`;
                html += createRewardHtml(task.reward_id);
                detailsContainer.innerHTML = html;
                detailsContainer.style.display = 'block';
            });

            // [Loot] 物品監聽
            lootItemSelect.addEventListener('change', () => {
                const selectedItemId = lootItemSelect.value;
                if (!selectedItemId) {
                    detailsContainer.style.display = 'none'; return;
                }
                const item = itemMasterList.get(selectedItemId);
                if (!item) return;

                let html = `<h3>${item.name_zh}</h3>`;
                html += `<p class="sub-name">${item.name_en || ''}</p>`;
                html += createDescriptionHtml(item);
                detailsContainer.innerHTML = html;
                detailsContainer.style.display = 'block';
            });

            // --- [ 啟動 ] ---
            try {
                // 檢查全域變數是否存在
                if (typeof allDatabase === 'undefined' || typeof allDescriptions === 'undefined') {
                    throw new Error("database.js 或 descriptions.js 檔案遺失或載入失敗。請檢查 <head> 中的 <script src=...></script> 標籤。");
                }
                
                // [已修復] 呼叫 initializeApp()
                initializeApp();
                
                console.log("應用程式已成功啟動 (同步模式)。");
            } catch (error) {
                console.error("啟動應用程式時發生錯誤:", error);
                 document.querySelector('.container').innerHTML = `<h1>資料載入失敗</h1>
                    <p>請檢查 <b>database.js</b> 和 <b>descriptions.js</b> 檔案是否存在於 index.html 旁邊。</p>
                    <p>錯誤訊息: ${error.message}</p>`;
            }
        }

        // 立即執行，因為 標籤在 底部
        startApp(allDatabase, allDescriptions);

    </script>
</body>
</html>
